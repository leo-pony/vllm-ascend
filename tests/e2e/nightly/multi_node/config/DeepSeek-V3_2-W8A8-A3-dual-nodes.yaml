test_name: "test DeepSeek-V3.2-W8A8 on A3"
model: "vllm-ascend/DeepSeek-V3.2-W8A8"
num_nodes: 4
cluster_hosts: ["172.22.0.188", "172.22.0.212","172.22.0.155","172.22.0.218"]
npu_per_node: 16
env_common:
  HCCL_OP_EXPANSION_MODE: "AIV"

  VLLM_USE_MODELSCOPE: true
  HCCL_BUFFSIZE: 256
  SERVER_PORT: 8080
  OMP_PROC_BIND: false
  OMP_NUM_THREADS: 1
  PYTORCH_NPU_ALLOC_CONF: "expandable_segments:True"
  VLLM_ASCEND_ENABLE_FLASHCOMM1: 1
  ASCEND_A3_EBA_ENABLE: 1
  TASK_QUEUE_ENABLE: 1
  HCCL_OP_RETRY_ENABLE: "L0:0, L1:0"
  ASCEND_AGGREGATE_ENABLE: 1
  ASCEND_TRANSPORT_PRINT: 1
  ACL_OP_INIT_MODE: 1
  VLLM_NIXL_ABORT_REQUEST_TIMEOUT: 300000

disaggregated_prefill:
  enabled: true
  prefiller_host_index: [0, 1]
  decoder_host_index: [2, 3]

deployment:
  -
    server_cmd: >
      vllm serve vllm-ascend/DeepSeek-V3.2-W8A8
      --host 0.0.0.0
      --port $SERVER_PORT
      --data-parallel-size 2
      --tensor-parallel-size 16
      --data-parallel-size-local 1
      --data-parallel-start-rank 0
      --data-parallel-address 172.22.0.188
      --data-parallel-rpc-port 13399
      --quantization ascend
      --seed 1024
      --enforce-eager
      --enable-expert-parallel
      --max-num-seqs 64
      --max-model-len 68000
      --max-num-batched-tokens 32550
      --no-enable-prefix-caching
      --gpu-memory-utilization 0.82
      --trust-remote-code
      --tokenizer-mode deepseek_v32
      --reasoning-parser deepseek_v3
      --kv-transfer-config
      '{"kv_connector": "MooncakeConnectorV1",
      "kv_role": "kv_producer",
      "kv_port": "30000",
      "engine_id": "0",
      "kv_connector_module_path": "vllm_ascend.distributed.mooncake_connector",
      "kv_connector_extra_config": {
                "prefill": {
                        "dp_size": 2,
                        "tp_size": 16
                },
                "decode": {
                        "dp_size": 8,
                        "tp_size": 4
                }
          }
      }'
      --additional-config
      '{"recompute_scheduler_enable":true}'

  -
    server_cmd: >
      vllm serve vllm-ascend/DeepSeek-V3.2-W8A8
      --headless
      --data-parallel-size 2
      --tensor-parallel-size 16
      --data-parallel-size-local 1
      --data-parallel-start-rank 1
      --data-parallel-address 172.22.0.188
      --data-parallel-rpc-port 13399
      --quantization ascend
      --seed 1024
      --enforce-eager
      --enable-expert-parallel
      --max-num-seqs 64
      --max-model-len 68000
      --max-num-batched-tokens 32550
      --no-enable-prefix-caching
      --gpu-memory-utilization 0.82
      --trust-remote-code
      --tokenizer-mode deepseek_v32
      --reasoning-parser deepseek_v3
      --kv-transfer-config
      '{"kv_connector": "MooncakeConnectorV1",
      "kv_role": "kv_producer",
      "kv_port": "30000",
      "engine_id": "0",
      "kv_connector_module_path": "vllm_ascend.distributed.mooncake_connector",
      "kv_connector_extra_config": {
                "prefill": {
                        "dp_size": 2,
                        "tp_size": 16
                },
                "decode": {
                        "dp_size": 8,
                        "tp_size": 4
                }
          }
      }'
      --additional-config
      '{"recompute_scheduler_enable":true}'

  -
    server_cmd: >
      vllm serve vllm-ascend/DeepSeek-V3.2-W8A8
      --host 0.0.0.0
      --port $SERVER_PORT
      --data-parallel-size 8
      --tensor-parallel-size 4
      --data-parallel-size-local 4
      --data-parallel-start-rank 0
      --data-parallel-rpc-port 12777
      --data-parallel-address 172.22.0.155
      --quantization ascend
      --seed 1024
      --enable-expert-parallel
      --async-scheduling
      --max-num-seqs 4
      --max-model-len 68000
      --max-num-batched-tokens 12
      --no-enable-prefix-caching
      --gpu-memory-utilization 0.95
      --trust-remote-code
      --tokenizer-mode deepseek_v32
      --reasoning-parser deepseek_v3
      --compilation-config '{"cudagraph_mode":"FULL_DECODE_ONLY",  "cudagraph_capture_sizes":[3, 6, 9, 12]}'
      --kv-transfer-config
      '{"kv_connector": "MooncakeConnectorV1",
      "kv_role": "kv_consumer",
      "kv_port": "30100",
      "engine_id": "1",
      "kv_connector_module_path": "vllm_ascend.distributed.mooncake_connector",
      "kv_connector_extra_config": {
                "prefill": {
                        "dp_size": 2,
                        "tp_size": 16
                },
                "decode": {
                        "dp_size": 8,
                        "tp_size": 4
                }
          }
      }'
      --additional-config
      '{"recompute_scheduler_enable":true}'

  -
    server_cmd: >
      vllm serve vllm-ascend/DeepSeek-V3.2-W8A8
      --headless
      --data-parallel-size 8
      --tensor-parallel-size 4
      --data-parallel-size-local 4
      --data-parallel-start-rank 4
      --data-parallel-rpc-port 12777
      --data-parallel-address 172.22.0.155
      --quantization ascend
      --seed 1024
      --enable-expert-parallel
      --async-scheduling
      --max-num-seqs 4
      --max-model-len 68000
      --max-num-batched-tokens 12
      --no-enable-prefix-caching
      --gpu-memory-utilization 0.95
      --trust-remote-code
      --tokenizer-mode deepseek_v32
      --reasoning-parser deepseek_v3
      --compilation-config '{"cudagraph_mode":"FULL_DECODE_ONLY",  "cudagraph_capture_sizes":[3, 6, 9, 12]}'
      --kv-transfer-config
      '{"kv_connector": "MooncakeConnectorV1",
      "kv_role": "kv_consumer",
      "kv_port": "30100",
      "engine_id": "1",
      "kv_connector_module_path": "vllm_ascend.distributed.mooncake_connector",
      "kv_connector_extra_config": {
                "prefill": {
                        "dp_size": 2,
                        "tp_size": 16
                },
                "decode": {
                        "dp_size": 8,
                        "tp_size": 4
                }
          }
      }'
      --additional-config
      '{"recompute_scheduler_enable":true}'

benchmarks:
  acc:
    case_type: accuracy
    dataset_path: vllm-ascend/gsm8k-lite
    request_conf: vllm_api_general_chat
    dataset_conf: gsm8k/gsm8k_gen_0_shot_cot_chat_prompt
    max_out_len: 4096
    batch_size: 64
    baseline: 95
    threshold: 5
